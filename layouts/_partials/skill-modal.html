{{/* Modal for displaying skill/technology details - Glassmorphism Design */}}
<div id="skillModal" class="skill-modal" style="display: none;">
    <div class="skill-modal-backdrop" onclick="closeSkillModal()"></div>
    <div class="skill-modal-content unified-modal-content">
        <div class="skill-modal-header unified-modal-header">
            <button class="skill-modal-close unified-modal-close" onclick="closeSkillModal()">&times;</button>

            <!-- Unified content header inside header -->
            <div class="skill-info skill-modal-header-section unified-modal-content-header">
                <div class="skill-modal-header-left unified-modal-content-header-left">
                    <div class="skill-modal-skill-icon-large unified-modal-icon-large" id="skillIconLarge">
                        <span id="modalSkillIcon"></span>
                    </div>
                    <div class="skill-modal-title-block unified-modal-title-block">
                        <h2 id="modalSkillName"></h2>
                        <div class="skill-modal-chips unified-modal-chips">
                            <span class="skill-modal-chip chip" id="modalSkillLevel" hidden></span>
                            <span class="skill-modal-chip chip secondary" id="modalSkillExperience" hidden></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unified tab bar inside header -->
            <div class="skill-modal-tabs unified-modal-tabs" role="tablist">
                <button class="skill-modal-tab tab-btn active" role="tab" aria-selected="true" aria-controls="skillModalTabProjects" data-tab="projects">
                    <span class="icon">üíº</span><span>Projets</span>
                    <span class="skill-modal-tab-count count" id="skillModalProjectsCount"></span>
                </button>
                <button class="skill-modal-tab tab-btn" role="tab" aria-selected="false" aria-controls="skillModalTabExperiences" data-tab="experiences">
                    <span class="icon">üè¢</span><span>Exp√©riences</span>
                    <span class="skill-modal-tab-count count" id="skillModalExperiencesCount"></span>
                </button>
                <button class="skill-modal-tab tab-btn" role="tab" aria-selected="false" aria-controls="skillModalTabEducations" data-tab="educations">
                    <span class="icon">üéì</span><span>Formations</span>
                    <span class="skill-modal-tab-count count" id="skillModalEducationsCount"></span>
                </button>
            </div>
        </div>

        <div class="skill-modal-body unified-modal-body skill-modal-layout">
            <!-- Panels -->
            <div class="skill-modal-tab-panels unified-modal-panels">
                <div class="skill-modal-tab-panel unified-modal-panel active" id="skillModalTabProjects" role="tabpanel" aria-labelledby="skillModalTabBtnProjects">
                    <div id="modalProjectsList" class="skill-modal-projects-grid" data-empty-text="Aucun projet trouv√© pour cette technologie.">
                        <!-- Projects -->
                    </div>
                </div>
                <div class="skill-modal-tab-panel unified-modal-panel" id="skillModalTabExperiences" role="tabpanel" aria-labelledby="skillModalTabBtnExperiences" hidden>
                    <div id="modalExperiencesList" class="skill-modal-experiences-list" data-empty-text="Aucune exp√©rience trouv√©e.">
                        <!-- Experiences -->
                    </div>
                </div>
                <div class="skill-modal-tab-panel unified-modal-panel" id="skillModalTabEducations" role="tabpanel" aria-labelledby="skillModalTabBtnEducations" hidden>
                    <div id="modalEducationsList" class="skill-modal-educations-list" data-empty-text="Aucune formation trouv√©e.">
                        <!-- Educations -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{/* Integrate project data into the page to avoid API requests */}}
<script>
window.portfolioProjects = [
    {{- range where .Site.RegularPages "Section" "projects" -}}
        {{- $allTechnologies := partial "get-all-technologies.html" . -}}
        
        {
            title: {{ .Title | jsonify }},
            subtitle: {{ (.Params.subtitle | default .Params.description) | jsonify }},
            description: {{ .Params.description | jsonify }},
            url: {{ .RelPermalink | jsonify }},
            image: {{ (.Params.image | default "/images/placeholder-project.jpg") | jsonify }},
            background_image: {{ (.Params.image | default "/images/placeholder-project.jpg") | jsonify }},
            year: {{ (.Params.year | default (.Date.Format "2006")) | jsonify }},
            technologies: {{ $allTechnologies | jsonify }},
            sector: {{ .Params.sector | jsonify }},
            featured: {{ .Params.featured | default false }},
            status: {{ .Params.status | jsonify }},
            github: {{ .Params.github | jsonify }},
            demo: {{ .Params.demo | jsonify }},
            website: {{ .Params.website | jsonify }},
            {{- if .Params.contributors -}}
            contributors: [
                {{- range .Params.contributors -}}
                {
                    person: "{{ .person }}",
                    {{- if .roles -}}
                    roles: {{ .roles | jsonify }},
                    role: "{{ delimit .roles ", " }}"
                    {{- else if .role -}}
                    role: "{{ .role }}",
                    roles: ["{{ .role }}"]
                    {{- else -}}
                    role: "Contributeur",
                    roles: ["Contributeur"]
                    {{- end -}}
                },
                {{- end -}}
            ],
            {{- else -}}
            contributors: [],
            {{- end -}}
            programming_languages: {{ .Params.programming_languages | jsonify }},
            frameworks_engines: {{ .Params.frameworks_engines | jsonify }},
            specialties: {{ .Params.specialties | jsonify }},
            tools: {{ .Params.tools | jsonify }}
        },
    {{- end -}}
];

window.portfolioExperiences = [
    {{- range where .Site.RegularPages "Section" "experiences" -}}
        {{- $allTechnologies := slice -}}
        {{- if .Params.programming_languages -}}
            {{- $allTechnologies = $allTechnologies | append .Params.programming_languages -}}
        {{- end -}}
        {{- if .Params.frameworks_engines -}}
            {{- $allTechnologies = $allTechnologies | append .Params.frameworks_engines -}}
        {{- end -}}
        {{- if .Params.specialties -}}
            {{- $allTechnologies = $allTechnologies | append .Params.specialties -}}
        {{- end -}}
        {{- $allTechnologies = $allTechnologies | uniq -}}
        
        {
            title: {{ .Title | jsonify }},
            company: {{ .Params.company | jsonify }},
            logo: {{ .Params.logo | jsonify }},
            start_date: {{ .Params.start_date | jsonify }},
            end_date: {{ .Params.end_date | jsonify }},
            type: {{ .Params.type | jsonify }},
            location: {{ .Params.location | jsonify }},
            description: {{ .Params.description | jsonify }},
            url: {{ .RelPermalink | jsonify }},
            technologies: {{ $allTechnologies | jsonify }},
            programming_languages: {{ .Params.programming_languages | jsonify }},
            frameworks_engines: {{ .Params.frameworks_engines | jsonify }},
            specialties: {{ .Params.specialties | jsonify }}
        },
    {{- end -}}
];

window.portfolioEducations = [
    {{- range where (where .Site.RegularPages "Section" "educations") ".Params.displayedInPortfolio" "!=" false -}}
        {{- $allTechnologies := slice -}}
        {{- if .Params.programming_languages -}}
            {{- $allTechnologies = $allTechnologies | append .Params.programming_languages -}}
        {{- end -}}
        {{- if .Params.frameworks_engines -}}
            {{- $allTechnologies = $allTechnologies | append .Params.frameworks_engines -}}
        {{- end -}}
        {{- if .Params.specialties -}}
            {{- $allTechnologies = $allTechnologies | append .Params.specialties -}}
        {{- end -}}
        {{- if .Params.soft_skills -}}
            {{- $allTechnologies = $allTechnologies | append .Params.soft_skills -}}
        {{- end -}}
        {{- $allTechnologies = $allTechnologies | uniq -}}
        
        {
            title: {{ .Title | jsonify }},
            institution: {{ .Params.institution | jsonify }},
            city: {{ .Params.city | jsonify }},
            start_date: {{ .Params.start_date | jsonify }},
            end_date: {{ .Params.end_date | jsonify }},
            status: {{ .Params.status | jsonify }},
            grade: {{ .Params.grade | jsonify }},
            description: {{ .Params.description | jsonify }},
            url: {{ .RelPermalink | jsonify }},
            icon: {{ .Params.icon | jsonify }},
            color: {{ .Params.color | jsonify }},
            technologies: {{ $allTechnologies | jsonify }},
            programming_languages: {{ .Params.programming_languages | jsonify }},
            frameworks_engines: {{ .Params.frameworks_engines | jsonify }},
            specialties: {{ .Params.specialties | jsonify }},
            soft_skills: {{ .Params.soft_skills | jsonify }}
        },
    {{- end -}}
];

// Tab management & skill modal statistics
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('skillModal');
    if (!modal) return;
    
    // Initialize TabController for skill modal - scoped to modal context to avoid interference
    const skillModalTabs = new TabController('#skillModal .skill-modal-tab', {
        contentSelector: '#skillModal .skill-modal-tab-panel',
        contentAttribute: 'data-tab',
        animationType: 'none', // Use CSS animations via class changes instead
        useHiddenAttribute: true,
        contentMatchingStrategy: 'id-pattern',
        idPattern: 'skillModalTab{Category}',
        enableKeyboardNav: true
    });
    
    const counts = {
        projects: document.getElementById('skillModalProjectsCount'),
        experiences: document.getElementById('skillModalExperiencesCount'),
        educations: document.getElementById('skillModalEducationsCount')
    };
    // quick stats removed

    // Hook into existing openSkillModal function to update statistics and activate default tab
    const originalOpen = window.openSkillModal;
    if (typeof originalOpen === 'function') {
        window.openSkillModal = function(name, icon, level, experience, iconType) {
            originalOpen(name, icon, level, experience, iconType);

            // Level chip: hide if "Non sp√©cifi√©" or empty
            try {
                const lvlEl = document.getElementById('modalSkillLevel');
                if (lvlEl) {
                    const raw = lvlEl.textContent ? lvlEl.textContent.trim() : '';
                    let hide = false;
                    if (!raw) hide = true;
                    else {
                        const normalized = raw.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
                        if (normalized === 'non specifie') hide = true;
                    }
                    if (hide) {
                        lvlEl.textContent = '';
                        lvlEl.style.display = 'none';
                        lvlEl.hidden = true;
                    } else {
                        lvlEl.style.display = '';
                        lvlEl.hidden = false;
                    }
                }
            } catch (e) { /* no-op */ }

            // Update experience chip: hide if "Non sp√©cifi√©" or 0, else show "X an(s) d'exp√©rience"
            try {
                const expEl = document.getElementById('modalSkillExperience');
                if (expEl) {
                    let shouldHide = false;
                    if (experience === null || experience === undefined) {
                        shouldHide = true;
                    } else if (typeof experience === 'number') {
                        shouldHide = !(experience > 0);
                    } else {
                        const raw = String(experience).trim();
                        if (!raw) {
                            shouldHide = true;
                        } else {
                            const normalized = raw.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
                            if (normalized === 'non specifie') {
                                shouldHide = true;
                            } else {
                                const parsed = parseFloat(raw.replace(/[^0-9.,-]/g, '').replace(',', '.'));
                                shouldHide = !(parsed > 0);
                            }
                        }
                    }

                    if (shouldHide) {
                        expEl.textContent = '';
                        expEl.style.display = 'none';
                    } else {
                        const yearsNum = typeof experience === 'number' ? experience : parseFloat(String(experience).replace(/[^0-9.,-]/g, '').replace(',', '.'));
                        const years = isNaN(yearsNum) ? 0 : yearsNum;
                        const isOne = Math.abs(years - 1) < 1e-9;
                        const yearsStr = Number.isInteger(years) ? years.toString() : years.toLocaleString('fr-FR', { maximumFractionDigits: 1 });
                        expEl.textContent = `${yearsStr} ${isOne ? 'an' : 'ans'} d'exp√©rience`;
                        expEl.style.display = '';
                    }
                }
            } catch (e) { /* no-op */ }

            updateStats(name);
            skillModalTabs.activateTab('projects');
        };
    }

    function updateStats(skillName) {
        const normalize = v => Array.isArray(v) ? v : (v ? [v] : []);
        const hasSkill = (arr) => arr.some(t => t && (t === skillName || t.toLowerCase() === skillName.toLowerCase()));

        const proj = (window.portfolioProjects||[]).filter(p => hasSkill(normalize(p.technologies||[])));
        const exp = (window.portfolioExperiences||[]).filter(e => hasSkill(normalize(e.technologies||[])));
        const edu = (window.portfolioEducations||[]).filter(ed => hasSkill(normalize(ed.technologies||[])));

        if (counts.projects) counts.projects.textContent = proj.length > 0 ? proj.length : '0';
        if (counts.experiences) counts.experiences.textContent = exp.length > 0 ? exp.length : '0';
        if (counts.educations) counts.educations.textContent = edu.length > 0 ? edu.length : '0';

        // quick stats removed
    }
});
</script>
