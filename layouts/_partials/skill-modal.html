{{/* Modal for displaying skill/technology details - Glassmorphism Design */}}
<div id="skillModal" class="skill-modal" style="display: none;">
    <div class="skill-modal-backdrop" onclick="closeSkillModal()"></div>
    <div class="skill-modal-content">
        <div class="skill-modal-header">
            <button class="skill-modal-close" onclick="closeSkillModal()">&times;</button>
        </div>
        
        <div class="skill-modal-body skill-modal-layout">
            <!-- Skill header -->
            <div class="skill-info skill-modal-header-section">
                <div class="skill-modal-header-left">
                                    <div class="skill-modal-skill-icon-large" id="skillIconLarge">
                        <span id="modalSkillIcon"></span>
                    </div>
                    <div class="skill-modal-title-block">
                        <h2 id="modalSkillName"></h2>
                        <div class="skill-modal-chips">
                            <span class="skill-modal-chip" id="modalSkillLevel"></span>
                            <span class="skill-modal-chip secondary" id="modalSkillExperience"></span>
                        </div>
                    </div>
                </div>
                <div class="skill-modal-header-right">
                    <div class="skill-modal-quick-stats" id="skillModalQuickStats">
                        <!-- Dynamic stats (projects, experiences, educations) -->
                    </div>
                </div>
            </div>

            <!-- Tab bar -->
            <div class="skill-modal-tabs" role="tablist">
                <button class="skill-modal-tab active" role="tab" aria-selected="true" aria-controls="skillModalTabProjects" data-tab="projects">
                    <span class="icon">üíº</span><span>Projets</span>
                    <span class="skill-modal-tab-count" id="skillModalProjectsCount"></span>
                </button>
                <button class="skill-modal-tab" role="tab" aria-selected="false" aria-controls="skillModalTabExperiences" data-tab="experiences">
                    <span class="icon">üè¢</span><span>Exp√©riences</span>
                    <span class="skill-modal-tab-count" id="skillModalExperiencesCount"></span>
                </button>
                <button class="skill-modal-tab" role="tab" aria-selected="false" aria-controls="skillModalTabEducations" data-tab="educations">
                    <span class="icon">üéì</span><span>Formations</span>
                    <span class="skill-modal-tab-count" id="skillModalEducationsCount"></span>
                </button>
            </div>

            <!-- Panels -->
            <div class="skill-modal-tab-panels">
                <div class="skill-modal-tab-panel active" id="skillModalTabProjects" role="tabpanel" aria-labelledby="skillModalTabBtnProjects">
                    <div id="modalProjectsList" class="skill-modal-projects-grid" data-empty-text="Aucun projet trouv√© pour cette technologie.">
                        <!-- Projects -->
                    </div>
                </div>
                <div class="skill-modal-tab-panel" id="skillModalTabExperiences" role="tabpanel" aria-labelledby="skillModalTabBtnExperiences" hidden>
                    <div id="modalExperiencesList" class="skill-modal-experiences-list" data-empty-text="Aucune exp√©rience trouv√©e.">
                        <!-- Experiences -->
                    </div>
                </div>
                <div class="skill-modal-tab-panel" id="skillModalTabEducations" role="tabpanel" aria-labelledby="skillModalTabBtnEducations" hidden>
                    <div id="modalEducationsList" class="skill-modal-educations-list" data-empty-text="Aucune formation trouv√©e.">
                        <!-- Educations -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{/* Integrate project data into the page to avoid API requests */}}
<script>
window.portfolioProjects = [
    {{- range where .Site.RegularPages "Section" "projects" -}}
        {{- $allTechnologies := partial "get-all-technologies.html" . -}}
        
        {
            title: {{ .Title | jsonify }},
            subtitle: {{ (.Params.subtitle | default .Params.description) | jsonify }},
            description: {{ .Params.description | jsonify }},
            url: {{ .RelPermalink | jsonify }},
            image: {{ (.Params.image | default "/images/placeholder-project.jpg") | jsonify }},
            background_image: {{ (.Params.image | default "/images/placeholder-project.jpg") | jsonify }},
            year: {{ (.Params.year | default (.Date.Format "2006")) | jsonify }},
            technologies: {{ $allTechnologies | jsonify }},
            sector: {{ .Params.sector | jsonify }},
            featured: {{ .Params.featured | default false }},
            status: {{ .Params.status | jsonify }},
            github: {{ .Params.github | jsonify }},
            demo: {{ .Params.demo | jsonify }},
            website: {{ .Params.website | jsonify }},
            {{- if .Params.contributors -}}
            contributors: [
                {{- range .Params.contributors -}}
                {
                    person: "{{ .person }}",
                    role: "{{ .role }}"
                },
                {{- end -}}
            ],
            {{- else -}}
            contributors: [],
            {{- end -}}
            programming_languages: {{ .Params.programming_languages | jsonify }},
            frameworks_engines: {{ .Params.frameworks_engines | jsonify }},
            specialties: {{ .Params.specialties | jsonify }},
            tools: {{ .Params.tools | jsonify }}
        },
    {{- end -}}
];

window.portfolioExperiences = [
    {{- range where .Site.RegularPages "Section" "experiences" -}}
        {{- $allTechnologies := slice -}}
        {{- if .Params.programming_languages -}}
            {{- $allTechnologies = $allTechnologies | append .Params.programming_languages -}}
        {{- end -}}
        {{- if .Params.frameworks_engines -}}
            {{- $allTechnologies = $allTechnologies | append .Params.frameworks_engines -}}
        {{- end -}}
        {{- if .Params.specialties -}}
            {{- $allTechnologies = $allTechnologies | append .Params.specialties -}}
        {{- end -}}
        {{- $allTechnologies = $allTechnologies | uniq -}}
        
        {
            title: {{ .Title | jsonify }},
            company: {{ .Params.company | jsonify }},
            logo: {{ .Params.logo | jsonify }},
            start_date: {{ .Params.start_date | jsonify }},
            end_date: {{ .Params.end_date | jsonify }},
            type: {{ .Params.type | jsonify }},
            location: {{ .Params.location | jsonify }},
            description: {{ .Params.description | jsonify }},
            url: {{ .RelPermalink | jsonify }},
            technologies: {{ $allTechnologies | jsonify }},
            programming_languages: {{ .Params.programming_languages | jsonify }},
            frameworks_engines: {{ .Params.frameworks_engines | jsonify }},
            specialties: {{ .Params.specialties | jsonify }}
        },
    {{- end -}}
];

window.portfolioEducations = [
    {{- range where (where .Site.RegularPages "Section" "educations") ".Params.displayedInPortfolio" "!=" false -}}
        {{- $allTechnologies := slice -}}
        {{- if .Params.programming_languages -}}
            {{- $allTechnologies = $allTechnologies | append .Params.programming_languages -}}
        {{- end -}}
        {{- if .Params.frameworks_engines -}}
            {{- $allTechnologies = $allTechnologies | append .Params.frameworks_engines -}}
        {{- end -}}
        {{- if .Params.specialties -}}
            {{- $allTechnologies = $allTechnologies | append .Params.specialties -}}
        {{- end -}}
        {{- if .Params.soft_skills -}}
            {{- $allTechnologies = $allTechnologies | append .Params.soft_skills -}}
        {{- end -}}
        {{- $allTechnologies = $allTechnologies | uniq -}}
        
        {
            title: {{ .Title | jsonify }},
            institution: {{ .Params.institution | jsonify }},
            city: {{ .Params.city | jsonify }},
            start_date: {{ .Params.start_date | jsonify }},
            end_date: {{ .Params.end_date | jsonify }},
            status: {{ .Params.status | jsonify }},
            grade: {{ .Params.grade | jsonify }},
            description: {{ .Params.description | jsonify }},
            url: {{ .RelPermalink | jsonify }},
            icon: {{ .Params.icon | jsonify }},
            color: {{ .Params.color | jsonify }},
            technologies: {{ $allTechnologies | jsonify }},
            programming_languages: {{ .Params.programming_languages | jsonify }},
            frameworks_engines: {{ .Params.frameworks_engines | jsonify }},
            specialties: {{ .Params.specialties | jsonify }},
            soft_skills: {{ .Params.soft_skills | jsonify }}
        },
    {{- end -}}
];

// Tab management & skill modal stats
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('skillModal');
    if (!modal) return;
    const tabButtons = modal.querySelectorAll('.skill-modal-tab');
    const tabPanels = modal.querySelectorAll('.skill-modal-tab-panel');
    const counts = {
        projects: document.getElementById('skillModalProjectsCount'),
        experiences: document.getElementById('skillModalExperiencesCount'),
        educations: document.getElementById('skillModalEducationsCount')
    };
    const quickStats = document.getElementById('skillModalQuickStats');

    function activateTab(target) {
        tabButtons.forEach(btn => {
            const isActive = btn.dataset.tab === target;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        });
        tabPanels.forEach(panel => {
            const shouldShow = panel.id === 'skillModalTab' + target.charAt(0).toUpperCase() + target.slice(1);
            panel.classList.toggle('active', shouldShow);
            if (shouldShow) {
                panel.removeAttribute('hidden');
            } else {
                panel.setAttribute('hidden','hidden');
            }
        });
    }

    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => activateTab(btn.dataset.tab));
        btn.addEventListener('keydown', e => {
            if (['ArrowRight','ArrowLeft'].includes(e.key)) {
                e.preventDefault();
                const arr = Array.from(tabButtons);
                const idx = arr.indexOf(btn);
                const next = e.key === 'ArrowRight' ? (idx + 1) % arr.length : (idx - 1 + arr.length) % arr.length;
                arr[next].focus();
            }
        });
    });

    // Hook on existing openSkillModal to update stats
    const originalOpen = window.openSkillModal;
    if (typeof originalOpen === 'function') {
        window.openSkillModal = function(name, icon, level, experience, iconType) {
            originalOpen(name, icon, level, experience, iconType);
            updateStats(name);
            activateTab('projects');
        };
    }

    function updateStats(skillName) {
        const normalize = v => Array.isArray(v) ? v : (v ? [v] : []);
        const hasSkill = (arr) => arr.some(t => t && (t === skillName || t.toLowerCase() === skillName.toLowerCase()));

        const proj = (window.portfolioProjects||[]).filter(p => hasSkill(normalize(p.technologies||[])));
        const exp = (window.portfolioExperiences||[]).filter(e => hasSkill(normalize(e.technologies||[])));
        const edu = (window.portfolioEducations||[]).filter(ed => hasSkill(normalize(ed.technologies||[])));

        if (counts.projects) counts.projects.textContent = proj.length > 0 ? proj.length : '0';
        if (counts.experiences) counts.experiences.textContent = exp.length > 0 ? exp.length : '0';
        if (counts.educations) counts.educations.textContent = edu.length > 0 ? edu.length : '0';

        if (quickStats) {
            quickStats.innerHTML = '';
            const stats = [
                { label: 'Projets', value: proj.length, icon: 'üíº'},
                { label: 'Exp√©riences', value: exp.length, icon: 'üè¢'},
                { label: 'Formations', value: edu.length, icon: 'üéì'}
            ];
            stats.forEach(s => {
                const el = document.createElement('div');
                el.className = 'skill-modal-stat-chip';
                el.innerHTML = `<span class="icon">${s.icon}</span><span class="val">${s.value}</span><span class="lbl">${s.label}</span>`;
                quickStats.appendChild(el);
            });
        }
    }
});
</script>
