{{/* 
  Auto Person Modal Loader
  Inclut automatiquement le person modal si des personnes sont d√©tect√©es sur la page
*/}}

{{/* Check if there are people on this page */}}
{{- $hasPersons := false -}}

{{/* Force inclusion if specified in parameters */}}
{{- if .Params.force_person_modal -}}
    {{- $hasPersons = true -}}
{{- end -}}

{{/* Check in testimonials data */}}
{{- if .Site.Data.testimonials -}}
    {{- $hasPersons = true -}}
{{- end -}}

{{/* Check in page parameters (contributors, testimonials) */}}
{{- if or .Params.contributors .Params.testimonials -}}
    {{- $hasPersons = true -}}
{{- end -}}

{{/* Include modal and resources only if necessary */}}
{{- if $hasPersons -}}
    {{/* Person Modal HTML */}}
    {{ partial "person-modal.html" . }}

    {{/* Debug script to analyze the issue */}}
    <script>
        window.debugPersonModal = function() {
            console.log('=== DEBUG PERSON MODAL ===');
            console.log('Current page:', window.location.pathname);
            console.log('portfolioPeople:', window.portfolioPeople);
            console.log('portfolioProjects:', window.portfolioProjects);
            console.log('portfolioTestimonials:', window.portfolioTestimonials);
            
            if (window.portfolioProjects && Array.isArray(window.portfolioProjects)) {
                console.log('Projects with contributors:');
                window.portfolioProjects.forEach((project, index) => {
                    console.log(`  ${index}. ${project.title}`);
                    if (project.contributors) {
                        project.contributors.forEach((contributor, cIndex) => {
                            console.log(`    - ${contributor.person} (${contributor.role})`);
                        });
                    }
                });
            }
            
            // Test for a specific contributor
            const testPersonId = 'francois-bertrand';
            console.log(`Testing projects for ${testPersonId}:`);
            if (window.portfolioProjects) {
                const personProjects = window.portfolioProjects.filter(project => 
                    project.contributors && project.contributors.some(contributor => contributor.person === testPersonId)
                );
                console.log(`Found ${personProjects.length} projects:`, personProjects);
            }
        };
        
        // Automatically launch debug after loading
        setTimeout(() => {
            console.log('Auto-running debug...');
            window.debugPersonModal();
        }, 1000);
    </script>

    {{/* CSS pour les personnes cliquables */}}
    {{ $clickablePersonCSS := resources.Get "scss/clickable-person.scss" | css.Sass | resources.Minify }}
    <link rel="stylesheet" href="{{ $clickablePersonCSS.RelPermalink }}">

    {{/* CSS pour le modal des personnes */}}
    {{ $personModalCSS := resources.Get "scss/person-modal.scss" | css.Sass | resources.Minify }}
    <link rel="stylesheet" href="{{ $personModalCSS.RelPermalink }}">

    {{/* Script d'initialisation */}}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit for all scripts to be loaded
        setTimeout(function() {
            // Verify that the person modal is available
            if (typeof window.openPersonModal === 'function') {
                console.log('Person modal ready - Found {{ len .Site.Data.testimonials }} testimonials');
                
                // Count clickable elements
                const clickablePersons = document.querySelectorAll('.clickable-person');
                console.log(`Found ${clickablePersons.length} clickable person elements`);
                
                // Ensure all elements with data-person-id are clickable
                const personElements = document.querySelectorAll('[data-person-id]');
                console.log(`Found ${personElements.length} elements with data-person-id`);
                
                personElements.forEach((element, index) => {
                    const personId = element.getAttribute('data-person-id');
                    console.log(`Element ${index}: person-id="${personId}"`);
                    
                    // Ensure click event is attached
                    if (!element.hasAttribute('data-click-attached')) {
                        element.setAttribute('data-click-attached', 'true');
                        element.style.cursor = 'pointer';
                        
                        element.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log(`Clicked on person: ${personId}`);
                            
                            if (typeof window.openPersonModal === 'function') {
                                window.openPersonModal(personId);
                            } else {
                                console.error('openPersonModal function not available');
                            }
                        });
                        
                        // Add visual indicator
                        element.style.position = 'relative';
                        
                        // Create small visual indicator
                        const indicator = document.createElement('div');
                        indicator.className = 'person-click-indicator';
                        indicator.innerHTML = 'üë§';
                        indicator.style.cssText = `
                            position: absolute;
                            top: -2px;
                            right: -2px;
                            width: 16px;
                            height: 16px;
                            background: var(--accent-color);
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 8px;
                            opacity: 0;
                            transition: opacity 0.3s ease;
                            pointer-events: none;
                            z-index: 10;
                        `;
                        
                        element.appendChild(indicator);
                        
                        // Display indicator on hover
                        element.addEventListener('mouseenter', () => {
                            indicator.style.opacity = '0.8';
                        });
                        
                        element.addEventListener('mouseleave', () => {
                            indicator.style.opacity = '0';
                        });
                    }
                });
            } else {
                console.warn('Person modal not loaded properly');
            }
        }, 500); // Attendre 500ms pour que tous les scripts soient charg√©s
    });
    </script>
{{- end -}}
