{{/*
  Partial: Testimonials Widget
  Description: Widget compact pour afficher les témoignages d'un projet
  Context: 
    - .Params (dict) - Paramètres du projet avec .testimonials
    - .File.BaseFileName (string) - ID du projet
*/}}

{{- if .Params.testimonials -}}
<div class="project-widget widget-testimonials-box {{ .Params.testimonials_size | default "size-large" }}" data-modal-title="Témoignages">
  <div class="project-widget-header" onclick="toggleInfoBox(this)">
    <div class="project-widget-header-content">
      {{- if .Params.testimonials -}}
        {{- $firstTestimonial := index .Params.testimonials 0 -}}
        {{- $firstPerson := partial "helpers/get-person.html" (dict "context" $ "personId" $firstTestimonial.person) -}}
        {{- if $firstPerson -}}
      <div class="project-widget-title-testimonial{{ if $firstPerson }} clickable-person{{ end }}"{{ if $firstPerson }} data-person-id="{{ $firstTestimonial.person }}" title="Voir le profil de {{ $firstPerson.Params.title }}"{{ end }}>
        <div class="project-widget-title-avatar {{ if not $firstPerson.Params.avatar }}placeholder{{ end }}">
          {{- if $firstPerson.Params.avatar -}}
          <img src="{{ $firstPerson.Params.avatar }}" alt="{{ $firstPerson.Params.title }}">
          {{- else -}}
          <span>{{ substr $firstPerson.Params.title 0 1 | upper }}</span>
          {{- end -}}
        </div>
        <h3 class="project-widget-title">{{ $firstPerson.Params.title }}{{ if $firstTestimonial.role }}, {{ $firstTestimonial.role }}{{ end }}</h3>
      </div>
        {{- end -}}
      {{- end -}}
      <!-- Aperçu rotatif des testimonials -->
      {{- if .Params.testimonials -}}
      <div class="widget-testimonials-preview">
        <div class="widget-testimonials-rotator">
          <!-- Zone unique pour afficher le témoignage actuel -->
          <div class="widget-testimonial-preview-content">
            <div class="widget-testimonial-preview-quote">
              {{- $firstTestimonial := index .Params.testimonials 0 -}}
              {{ $firstTestimonial.quote | markdownify | default "Témoignage en cours de chargement..." }}
            </div>
          </div>
          
          <!-- Données cachées pour le JavaScript -->
          <div class="widget-testimonials-data" style="display: none;">
            {{- range $index, $testimonial := .Params.testimonials -}}
              {{- $person := partial "helpers/get-person.html" (dict "context" $ "personId" $testimonial.person) -}}
            <div class="widget-testimonial-data-item" data-index="{{ $index }}" data-testimonial-quote="{{ $testimonial.quote }}"{{ if $person }} data-person-id="{{ $testimonial.person }}" data-person-name="{{ $person.Params.title }}{{ if $testimonial.role }}, {{ $testimonial.role }}{{ end }}" data-person-avatar="{{ $person.Params.avatar }}" data-person-title="Voir le profil de {{ $person.Params.title }}"{{ else }}{{ if $testimonial.person }} data-person-name="{{ $testimonial.person }}{{ if $testimonial.role }}, {{ $testimonial.role }}{{ end }}"{{ end }}{{ end }}></div>
            {{- end -}}
          </div>
        </div>
        <div class="widget-testimonials-progress"></div>
      </div>
      {{- end -}}
    </div>
    <div class="project-widget-toggle">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
      </svg>
    </div>
  </div>
  <div class="project-widget-content">
    {{/* Nouveau modal unifié pour les témoignages */}}
    {{ partial "projects/widgets/modal/testimonials.html" (dict "testimonials" .Params.testimonials "projectId" .File.BaseFileName "context" .) }}
  </div>
</div>
{{- end -}}