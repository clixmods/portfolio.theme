{{/*
  Partial: Tools Modal Layout
  Description: HTML structure for displaying tools used in project widget modals
  Context: 
    - .tools (slice) - List of tools used in the project
    - .projectId (string) - Project ID for contextualizing actions
    - .profileData (dict) - Profile data for the developer section
*/}}

{{- $tools := .tools -}}
{{- $projectId := .projectId | default "" -}}
{{- $profileData := .profileData -}}

{{/* DEBUG - Display received tools */}}
<!-- DEBUG: Tools received: {{ $tools }} -->
<!-- DEBUG: Total tools in data: {{ len site.Data.tools }} -->

{{/* Fetch tool data from site.Data.tools */}}
{{- $allTools := site.Data.tools -}}
{{- $usedTools := slice -}}
{{- $totalExperience := 0 -}}
{{- $toolCategories := dict -}}

{{/* Process used tools */}}
{{- range $toolName := $tools -}}
  {{- range $allTools -}}
    {{- if eq .name $toolName -}}
      {{- $usedTools = $usedTools | append . -}}
      {{- $totalExperience = add $totalExperience .experience -}}
      
      {{/* Group by category */}}
      {{- $category := .category | default "other" -}}
      {{- $categoryTools := index $toolCategories $category | default slice -}}
      {{- $categoryTools = $categoryTools | append . -}}
      {{- $toolCategories = merge $toolCategories (dict $category $categoryTools) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $total := len $usedTools -}}

{{- if gt $total 0 -}}
  <div class="tools-modal">
    {{/* Statistics bar */}}
    <div class="tools-stats-bar">
      <div class="widget-count">
        <strong>{{ $total }}</strong> outil{{ if gt $total 1 }}s{{ end }}
      </div>
      {{/* Display grouped categories */}}
      <div class="tools-categories">
        {{- $displayedCategories := dict -}}
        {{- range $category, $categoryTools := $toolCategories -}}
          {{- $categoryName := "" -}}
          {{- if eq $category "version_control" -}}{{ $categoryName = "Contr√¥le de version" }}
          {{- else if eq $category "development" -}}{{ $categoryName = "D√©veloppement" }}
          {{- else if eq $category "design" -}}{{ $categoryName = "Design" }}
          {{- else if eq $category "productivity" -}}{{ $categoryName = "Productivit√©" }}
          {{- else if eq $category "communication" -}}{{ $categoryName = "Communication" }}
          {{- else -}}{{ $categoryName = "Autres" }}
          {{- end -}}
          
          {{/* Group categories with the same name */}}
          {{- $existingTools := index $displayedCategories $categoryName | default slice -}}
          {{- $existingTools = $existingTools | append $categoryTools -}}
          {{- $displayedCategories = merge $displayedCategories (dict $categoryName $existingTools) -}}
        {{- end -}}
        
        {{/* Display grouped categories */}}
        {{- range $displayName, $toolGroups := $displayedCategories -}}
          {{- $totalTools := 0 -}}
          {{- range $toolGroups -}}
            {{- $totalTools = add $totalTools (len .) -}}
          {{- end -}}
          <div class="tool-category-chip widget-badge widget-badge--sm">
            {{ $displayName }} ({{ $totalTools }})
          </div>
        {{- end -}}
      </div>
    </div>
    
    {{/* Developer note */}}
    {{- if $profileData -}}
    <div class="developer-profile-note">
      <div class="profile-avatar widget-icon widget-icon--lg">
        <img src="{{ $profileData.media.profileImage }}" alt="{{ $profileData.personal.fullName }}" loading="lazy">
      </div>
      <div class="profile-note-content">
        <div class="profile-note-title">Outils utilis√©s par {{ $profileData.personal.firstName }} pour ce projet</div>
        <div class="profile-note-subtitle">{{ $profileData.personal.title }}</div>
      </div>
    </div>
    {{- end -}}
    
    {{/* Tools grid by category - grouped by category name */}}
    {{- $sectionsByName := dict -}}
    {{- range $category, $categoryTools := $toolCategories -}}
      {{- $categoryName := "" -}}
      {{- if eq $category "version_control" -}}{{ $categoryName = "Contr√¥le de version" }}
      {{- else if eq $category "development" -}}{{ $categoryName = "D√©veloppement" }}
      {{- else if eq $category "design" -}}{{ $categoryName = "Design" }}
      {{- else if eq $category "productivity" -}}{{ $categoryName = "Productivit√©" }}
      {{- else if eq $category "communication" -}}{{ $categoryName = "Communication" }}
      {{- else -}}{{ $categoryName = "Autres" }}
      {{- end -}}
      
      {{/* Regrouper les outils par nom de cat√©gorie affich√© */}}
      {{- $existingTools := index $sectionsByName $categoryName | default slice -}}
      {{- range $categoryTools -}}
        {{- $existingTools = $existingTools | append . -}}
      {{- end -}}
      {{- $sectionsByName = merge $sectionsByName (dict $categoryName $existingTools) -}}
    {{- end -}}
    
    {{/* Afficher une section par nom de cat√©gorie */}}
    {{- range $sectionName, $sectionTools := $sectionsByName -}}
      <div class="tools-category-section">
        <div class="tools-category-title">{{ $sectionName }}</div>
        
        <div class="tools-grid">
          {{- range $sectionTools -}}
            {{- $toolName := .name | default "Outil" -}}
            {{- $toolDescription := .description | default "" -}}
            {{- $toolExperience := .experience | default 0 -}}
            {{- $toolIcon := .iconPath | default "" -}}
            {{- $toolColor := .color | default "#666" -}}
            
            <div class="tool-card widget-card" 
                 data-tool="{{ $toolName }}" 
                 tabindex="0" 
                 role="button" 
                 aria-label="Voir les d√©tails de {{ $toolName }}"
                 onclick="openSkillModal('{{ $toolName }}', '{{ if $toolIcon }}/{{ $toolIcon }}{{ else }}üõ†Ô∏è{{ end }}', 'Outil', '{{ $toolExperience }} an{{ if gt $toolExperience 1 }}s{{ end }}', '{{ if $toolIcon }}svg{{ else }}emoji{{ end }}')"
                 style="cursor: pointer;">
              
              {{/* En-t√™te de l'outil */}}
              <div class="tool-header">
                <div class="tool-icon widget-icon widget-icon--lg" aria-hidden="true">
                  {{- if $toolIcon -}}
                    <img src="/{{ $toolIcon }}" alt="{{ $toolName }}" loading="lazy">
                  {{- else -}}
                    üõ†Ô∏è
                  {{- end -}}
                </div>
                <div class="tool-info">
                  <div class="tool-title">{{ $toolName }}</div>
                  {{- if $toolDescription -}}
                    <div class="tool-description">{{ $toolDescription }}</div>
                  {{- end -}}
                </div>
              </div>
              
              {{/* Badge avec ann√©es d'exp√©rience */}}
              <div class="tool-badge widget-badge">
                {{ $toolExperience }} an{{ if gt $toolExperience 1 }}s{{ end }}
              </div>
            </div>
          {{- end -}}
        </div>
      </div>
    {{- end -}}
    
    {{/* Note d'interaction */}}
    <div class="tools-interaction-note">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z"/>
      </svg>
      Cliquez sur un outil pour voir les projets associ√©s et plus de d√©tails
    </div>
  </div>
{{- else -}}
  <div class="tools-modal">
    <div class="tools-stats-bar">
      <div class="widget-count">
        <strong>0</strong> outils
      </div>
    </div>
    
    <div class="tools-empty-state widget-note">
      <div class="widget-note-header">
        <div class="widget-note-icon widget-icon widget-icon--md">üõ†Ô∏è</div>
        <div class="widget-note-title">Aucun outil sp√©cifique</div>
      </div>
      <div class="widget-note-content">
        <p>Ce projet n'utilise pas d'outils sp√©cifiques r√©pertori√©s dans le portfolio.</p>
      </div>
    </div>
  </div>
{{- end -}}