{{/*
  Partial: Contributors Modal Enhanced Layout
  Description: HTML structure for enhanced display of contributors in project widget modals
  Context: 
    - .contributors (slice) - List of contributors with their data
    - .projectId (string) - Project ID for contextualizing actions
*/}}

{{- $contributors := .contributors -}}
{{- $projectId := .projectId | default "" -}}

{{- if $contributors -}}
  {{- $total := len $contributors -}}
  {{- $groups := dict -}}
  {{- $distinctRoles := slice -}}
  
  {{/* Load role weights from JSON file first */}}
  {{- $rolesData := site.Data.role_contributor -}}
  {{- $roleWeights := dict -}}
  {{- range $rolesData -}}
    {{- $roleWeights = merge $roleWeights (dict .name (.weight | default 50)) -}}
  {{- end -}}
  
  {{/* Assign each contributor to their most important role */}}
  {{- range $contributor := $contributors -}}
    {{/* Support des deux formats: roles (tableau) et role (string legacy) */}}
    {{- $contributorRoles := slice -}}
    
    {{/* Check first if roles exists and is not empty */}}
    {{- if $contributor.roles -}}
      {{- $contributorRoles = $contributor.roles -}}
    {{- else if $contributor.role -}}
      {{/* Fallback to old role format */}}
      {{- $contributorRoles = slice $contributor.role -}}
    {{- else -}}
      {{/* Default if no role is defined */}}
      {{- $contributorRoles = slice "Contributeur" -}}
    {{- end -}}
    
    {{/* Find the role with the highest weight */}}
    {{- $highestWeight := 0 -}}
    {{- $primaryRole := "" -}}
    {{- range $role := $contributorRoles -}}
      {{- $weight := index $roleWeights $role | default 50 -}}
      {{- if gt $weight $highestWeight -}}
        {{- $highestWeight = $weight -}}
        {{- $primaryRole = $role -}}
      {{- end -}}
    {{- end -}}
    
    {{/* Assign contributor to their primary role only */}}
    {{- if $primaryRole -}}
      {{- $existing := index $groups $primaryRole | default (slice) -}}
      {{- $groups = merge $groups (dict $primaryRole ($existing | append $contributor)) -}}
      {{/* Add role to list if not already present */}}
      {{- if not (in $distinctRoles $primaryRole) -}}
        {{- $distinctRoles = $distinctRoles | append $primaryRole -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  <div class="contributors-modal-enhanced">
    <div class="contributors-stats-bar">
      <div class="contributors-count">
        <strong>{{ $total }}</strong> contributeur{{ if gt $total 1 }}s{{ end }}
      </div>
      <div class="contributors-roles">
        {{- range $role := $distinctRoles -}}
          {{- $count := len (index $groups $role) -}}
          <span class="contrib-role-chip">{{ $role }} ({{ $count }})</span>
        {{- end -}}
      </div>
    </div>
    
    {{/* Developer note - Search for Clément among contributors */}}
    {{- $ownerContributor := dict -}}
    {{- range $contributors -}}
      {{- if eq .id "clement-garcia" -}}
        {{- $ownerContributor = . -}}
      {{- end -}}
    {{- end -}}
    
    {{- if $ownerContributor.id -}}
    <div class="developer-profile-note">
      <div class="profile-avatar">
        {{- if $ownerContributor.hasAvatar -}}
          {{- $ownerAvatar := partial "get-optimized-image.html" (dict "imagePath" $ownerContributor.avatarPath "width" 80 "quality" 90) -}}
          <img src="{{ $ownerAvatar.src }}" width="{{ $ownerAvatar.width }}" height="{{ $ownerAvatar.height }}" alt="{{ $ownerContributor.name }}" loading="lazy">
        {{- else -}}
          <span>{{ substr $ownerContributor.name 0 1 | upper }}</span>
        {{- end -}}
      </div>
      <div class="profile-note-content">
        <div class="profile-note-title">Rôle{{ if gt (len ($ownerContributor.roles | default (slice))) 1 }}s{{ end }} de {{ $ownerContributor.name }} dans ce projet</div>
        <div class="profile-note-subtitle">
          {{- $ownerRoles := $ownerContributor.roles | default (slice ($ownerContributor.role | default "Contributeur")) -}}
          {{- delimit $ownerRoles ", " -}}
        </div>
      </div>
    </div>
    {{- end -}}
    
    {{/* Sort roles by weight (from most important to least important) */}}
    {{- $sortedRoles := slice -}}
    {{- range $distinctRoles -}}
      {{- $weight := index $roleWeights . | default 50 -}}
      {{- $sortedRoles = $sortedRoles | append (dict "name" . "weight" $weight) -}}
    {{- end -}}
    
    {{/* Sort by descending weight */}}
    {{- $sortedRoles = sort $sortedRoles "weight" "desc" -}}
    
    {{- range $roleData := $sortedRoles -}}
      {{- $role := $roleData.name -}}
      {{- $roleContributors := index $groups $role -}}
      <div class="contributors-group">
        <div class="contributors-group-title">{{ $role }}</div>
        <div class="contributors-grid">
          {{- range $roleContributors -}}
            {{- $initials := substr (.name | default "?") 0 1 | upper -}}
            {{- $personId := .id | default "" -}}
            {{- $personName := .name | default "Contributeur" -}}
            {{- $personRoles := .roles | default (slice (.role | default "")) -}}
            {{- $personRole := delimit $personRoles ", " -}}
            {{- $hasAvatar := .hasAvatar | default false -}}
            {{- $avatarPath := .avatarPath | default "" -}}
            {{- $isOwner := eq $personId "clement-garcia" -}}
            
            <div class="contrib-card{{ if $isOwner }} contrib-card--owner{{ end }}" 
                 data-person-id="{{ $personId }}" 
                 tabindex="0" 
                 role="button" 
                 aria-label="Voir le profil de {{ $personName }}"
                 style="cursor: pointer;">
              
              {{/* Contributor avatar */}}
              <div class="contrib-avatar{{ if not $hasAvatar }} placeholder{{ end }}">
                {{- if $hasAvatar -}}
                  {{- $contribAvatar := partial "get-optimized-image.html" (dict "imagePath" $avatarPath "width" 80 "quality" 90) -}}
                  <img src="{{ $contribAvatar.src }}" width="{{ $contribAvatar.width }}" height="{{ $contribAvatar.height }}" alt="Avatar de {{ $personName }}" loading="lazy" />
                {{- else -}}
                  <span>{{ $initials }}</span>
                {{- end -}}
              </div>
              
              {{/* Contributor information */}}
              <div class="contrib-info">
                <div class="contrib-name">{{ $personName }}</div>
                {{- if $personRole -}}
                  <div class="contrib-role">{{ $personRole }}</div>
                {{- end -}}
              </div>
            </div>
          {{- end -}}
        </div>
      </div>
    {{- end -}}
  </div>
{{- else -}}
  <div class="contributors-modal-enhanced">
    <div class="contributors-stats-bar">
      <div class="contributors-count">
        <strong>0</strong> contributeurs
      </div>
    </div>
    <div class="contributors-group">
      <div class="contributors-group-title">Aucun contributeur</div>
      <div class="contributors-grid">
        <p>Aucun contributeur n'a été trouvé pour ce projet.</p>
      </div>
    </div>
  </div>
{{- end -}}