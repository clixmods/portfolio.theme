{{/* ============================================================ */}}
{{/* TEMPLATE OVERLAYS - Grain, Waves & Particles */}}
{{/* ============================================================ */}}

{{/* Grain Overlay - Film noise effect */}}
<div class="template-grain" id="template-grain"></div>

{{/* Particles - Always visible by default */}}
<div class="template-particles" id="template-particles">
    <canvas id="branding-particles-canvas"></canvas>
</div>

{{/* SVG Waves - Hidden by default */}}
<div class="template-waves hidden" id="template-waves">
    <svg class="wave-svg wave-1" viewBox="0 0 1440 320" preserveAspectRatio="none">
        <path class="wave-path" d="M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,181.3C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
    </svg>
    <svg class="wave-svg wave-2" viewBox="0 0 1440 320" preserveAspectRatio="none">
        <path class="wave-path" d="M0,64L48,80C96,96,192,128,288,128C384,128,480,96,576,90.7C672,85,768,107,864,144C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
    </svg>
    <svg class="wave-svg wave-3" viewBox="0 0 1440 320" preserveAspectRatio="none">
        <path class="wave-path" d="M0,224L48,213.3C96,203,192,181,288,154.7C384,128,480,96,576,106.7C672,117,768,171,864,186.7C960,203,1056,181,1152,154.7C1248,128,1344,96,1392,80L1440,64L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
    </svg>
</div>

{{/* Particles Script */}}
<script>
document.addEventListener('DOMContentLoaded', function() {
  'use strict';
  
  /**
   * Seeded Random Generator for consistent animations
   */
  class SeededRandom {
    constructor(seed = 12345) {
      this.seed = seed;
      this.originalSeed = seed;
    }
    
    reset() {
      this.seed = this.originalSeed;
    }
    
    next() {
      this.seed = (this.seed * 1664525 + 1013904223) % (2**32);
      return this.seed / (2**32);
    }
  }
  
  /**
   * Branding Particles - Canvas-based particle system
   */
  class BrandingParticles {
    constructor(container, config = {}) {
      this.container = container;
      this.canvas = container.querySelector('#branding-particles-canvas');
      if (!this.canvas) {
        console.warn('Canvas branding-particles-canvas not found');
        return;
      }
      
      this.ctx = this.canvas.getContext('2d');
      this.particles = [];
      this.animationId = null;
      
      // Apply config with defaults
      const seed = config.seed || 123;
      this.particleRng = new SeededRandom(seed);
      this.speedMultiplier = config.speed || 1.0;
      this.sizeMultiplier = config.size || 1.0;
      
      this.config = {
        count: config.count || 60,
        colors: ['#FFFFFF', '#B0D2FF', '#D8ECFF'],
        sizes: [1, 1.5, 2, 2.5],
        opacities: [0.4, 0.5, 0.6, 0.7],
        bokehChance: 0.05
      };
      
      this.init();
    }
    
    init() {
      this.resizeCanvas();
      this.createParticles();
      this.animate();
    }
    
    resizeCanvas() {
      const previewCanvas = document.getElementById('preview-canvas');
      if (previewCanvas) {
        this.canvas.width = previewCanvas.offsetWidth || 1280;
        this.canvas.height = previewCanvas.offsetHeight || 720;
      } else {
        const rect = this.container.getBoundingClientRect();
        this.canvas.width = rect.width || 1280;
        this.canvas.height = rect.height || 720;
      }
    }
    
    createParticle(index = null) {
      if (index !== null) {
        this.particleRng.seed = this.particleRng.originalSeed + index * 17;
      }
      
      const isNearWaves = this.particleRng.next() < 0.4;
      let x, y;
      
      if (isNearWaves) {
        x = this.particleRng.next() * this.canvas.width;
        y = this.canvas.height * 0.5 + (this.particleRng.next() - 0.5) * 150;
      } else {
        x = this.particleRng.next() * this.canvas.width;
        y = this.particleRng.next() * (this.canvas.height * 0.8);
        
        if (this.particleRng.next() < 0.6) {
          x = this.canvas.width * 0.3 + this.particleRng.next() * this.canvas.width * 0.7;
          y = this.particleRng.next() * this.canvas.height * 0.5;
        }
      }
      
      return {
        x, y,
        size: this.config.sizes[Math.floor(this.particleRng.next() * this.config.sizes.length)],
        color: this.config.colors[Math.floor(this.particleRng.next() * this.config.colors.length)],
        baseOpacity: this.config.opacities[Math.floor(this.particleRng.next() * this.config.opacities.length)],
        opacity: 0,
        bokeh: this.particleRng.next() < this.config.bokehChance,
        drift: {
          x: (this.particleRng.next() - 0.5) * 0.15,
          y: (this.particleRng.next() - 0.5) * 0.15
        },
        pulse: this.particleRng.next() * Math.PI * 2,
        age: 0,
        maxAge: 800 + this.particleRng.next() * 1500,
        shape: this.particleRng.next() < 0.3 ? 'hexagon' : 'circle',
        index: index !== null ? index : -1
      };
    }
    
    createParticles() {
      this.particles = [];
      for (let i = 0; i < this.config.count; i++) {
        this.particles.push(this.createParticle(i));
      }
    }
    
    updateParticle(particle) {
      particle.age++;
      
      particle.x += particle.drift.x * this.speedMultiplier;
      particle.y += particle.drift.y * this.speedMultiplier;
      
      const systemTime = Date.now() / 1000;
      const pulseOffset = Math.sin(systemTime * 2 + particle.pulse) * 0.1;
      particle.opacity = Math.max(0.1, Math.min(1, particle.baseOpacity + pulseOffset));
      
      const ageRatio = particle.age / particle.maxAge;
      if (ageRatio < 0.1) {
        particle.opacity *= ageRatio / 0.1;
      } else if (ageRatio > 0.9) {
        particle.opacity *= (1 - ageRatio) / 0.1;
      }
      
      if (particle.age >= particle.maxAge || 
          particle.x < -50 || particle.x > this.canvas.width + 50 || 
          particle.y < -50 || particle.y > this.canvas.height + 50) {
        Object.assign(particle, this.createParticle(particle.index));
      }
    }
    
    drawParticle(particle) {
      this.ctx.save();
      this.ctx.globalAlpha = particle.opacity;
      
      if (particle.bokeh) {
        this.ctx.filter = 'blur(2px)';
      }
      
      // Apply size multiplier
      const size = particle.size * this.sizeMultiplier;
      
      this.ctx.fillStyle = particle.color;
      this.ctx.beginPath();
      
      if (particle.shape === 'hexagon') {
        const sides = 6;
        const angle = Math.PI * 2 / sides;
        this.ctx.moveTo(
          particle.x + size * Math.cos(0),
          particle.y + size * Math.sin(0)
        );
        for (let i = 1; i <= sides; i++) {
          this.ctx.lineTo(
            particle.x + size * Math.cos(i * angle),
            particle.y + size * Math.sin(i * angle)
          );
        }
      } else {
        this.ctx.arc(particle.x, particle.y, size, 0, Math.PI * 2);
      }
      
      this.ctx.fill();
      this.ctx.restore();
    }
    
    animate() {
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
      
      this.particles.forEach(particle => {
        this.updateParticle(particle);
        this.drawParticle(particle);
      });
      
      this.animationId = requestAnimationFrame(this.animate.bind(this));
    }
    
    resize() {
      this.resizeCanvas();
    }
    
    setOpacity(value) {
      this.canvas.style.opacity = value;
    }
    
    setSpeed(value) {
      this.speedMultiplier = value;
    }
    
    setSize(value) {
      this.sizeMultiplier = value;
    }
    
    pause() {
      if (this.animationId) {
        cancelAnimationFrame(this.animationId);
        this.animationId = null;
      }
    }
    
    play() {
      if (!this.animationId) {
        this.animate();
      }
    }
    
    destroy() {
      this.pause();
      this.particles = [];
    }
  }
  
  // Expose globally for branding controls
  window.BrandingParticles = BrandingParticles;
});
</script>
