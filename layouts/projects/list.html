{{ define "main" }}
{{/* CSS PS5 d√©j√† charg√© via head. Garde fallback s√©curis√© si besoin. */}}
{{ with resources.Get "css/ps5-projects.css" }}
<link rel="stylesheet" href="{{ .RelPermalink }}">
{{ end }}
<!-- Pr√©chargement du placeholder pour √©viter requ√™tes r√©p√©t√©es -->
<link rel="preload" as="image" href="/images/placeholder-project.jpg">

<div class="ps5-projects-page">
    <!-- Fond dynamique projet -->
    <div id="project-bg" aria-hidden="true"></div>
    <!-- En-t√™te global projets -->
    <section class="projects-page-header" aria-labelledby="projects-main-title">
        <div class="projects-heading-block">
            <h1 id="projects-main-title" class="projects-list-title">{{ .Title | default (i18n "projects_title" | default "Mes projets") }}</h1>
            <p class="projects-list-subtitle">
                {{ .Params.description | default ( i18n "projects_list_subtitle" | default "S√©lection de mes cr√©ations : jeux vid√©o, applications web et outils de d√©veloppement." ) }}
            </p>
        </div>
        <!-- Stats rapides optionnelles -->
        <div class="projects-quick-stats">
            {{ $all := where .Site.RegularPages "Section" "projects" }}
            <div class="pqs-item"><span class="pqs-number">{{ len $all }}</span><span class="pqs-label">{{ i18n "total_projects" | default "Total" }}</span></div>
            <div class="pqs-item"><span class="pqs-number">{{ len (where $all ".Params.sector" "games") }}</span><span class="pqs-label">{{ i18n "games" | default "Jeux" }}</span></div>
            <div class="pqs-item"><span class="pqs-number">{{ len (where $all ".Params.sector" "apps-web") }}</span><span class="pqs-label">{{ i18n "apps_web" | default "Apps/Web" }}</span></div>
            <div class="pqs-item"><span class="pqs-number">{{ len (where $all ".Params.sector" "mods-tools") }}</span><span class="pqs-label">{{ i18n "mods_tools" | default "Mods & Tools" }}</span></div>
        </div>
    </section>

    <!-- Barre de filtres sticky (secteurs) -->
    <div class="projects-filters-bar" role="toolbar" aria-label="Filtres projets">
    <nav class="ps5-sectors" aria-label="Types de projets">
                <button class="ps5-sector-btn active" data-sector="all">
                    <span class="ps5-sector-icon">ÔøΩ</span>
                    <span class="ps5-sector-label">{{ i18n "all_projects" | default "Tous les projets" }}</span>
                </button>
                <button class="ps5-sector-btn" data-sector="games">
                    <span class="ps5-sector-icon">ÔøΩ</span>
                    <span class="ps5-sector-label">{{ i18n "games" | default "Jeux" }}</span>
                </button>
                <button class="ps5-sector-btn" data-sector="apps-web">
                    <span class="ps5-sector-icon">üåê</span>
                    <span class="ps5-sector-label">{{ i18n "apps_web" | default "Apps/Web" }}</span>
                </button>
                <button class="ps5-sector-btn" data-sector="mods-tools">
                    <span class="ps5-sector-icon">üõ†Ô∏è</span>
                    <span class="ps5-sector-label">{{ i18n "mods_tools" | default "Mods & Tools" }}</span>
                </button>
        </nav>
    </div>

    <!-- Grille de projets scrollable -->
    <div class="projects-scroll-area">
    <div class="ps5-projects-tiles">
        {{/* On liste tous les projets (hors _index) */}}
        {{ $projects := where .Site.RegularPages "Section" "projects" }}
        {{ range $projects }}
        {{ if not (eq .File.LogicalName "_index.md") }}
    <article class="ps5-project-tile"
         data-project-id="{{ .File.BaseFileName }}"
         data-background-image="{{ .Params.background_image | default .Params.image }}"
         data-sector="{{ .Params.sector }}"
         data-category="{{ .Params.sector }}"
         data-technologies='{{ with .Params.technologies }}{{ delimit . "," }}{{ end }}'>
            <!-- Image principale -->
            <div class="ps5-tile-image">
                <img loading="lazy" src="{{ with .Params.image }}{{ . | relURL }}{{ else }}{{ "images/placeholder-project.jpg" | relURL }}{{ end }}" alt="{{ .Title }}" onerror="this.onerror=null;this.src='/images/placeholder-project.jpg';">
                <div class="ps5-tile-overlay"></div>
            </div>

            <!-- Badge featured -->
            {{ if .Params.featured }}<div class="ps5-tile-badge">‚òÖ</div>{{ end }}

            <!-- Ic√¥ne secteur -->
            <div class="ps5-tile-sector-icon">
                {{ if eq .Params.sector "games" }}üéÆ{{ end }}
                {{ if eq .Params.sector "apps-web" }}üõí{{ end }}
                {{ if eq .Params.sector "mods-tools" }}ÔøΩ{{ end }}
            </div>

            <!-- Contenu court -->
            <div class="ps5-tile-content">
                <h3 class="ps5-tile-title">{{ .Title }}</h3>
                {{ with .Params.subtitle }}<p class="ps5-tile-subtitle">{{ . }}</p>{{ end }}
            </div>

            <!-- Overlay d√©taill√© -->
            <div class="ps5-tile-info">
                <div class="ps5-tile-info-content">
                    <h3 class="ps5-tile-info-title">{{ .Title }}</h3>
                    {{ with .Params.subtitle }}<p class="ps5-tile-info-subtitle">{{ . }}</p>{{ end }}
                    {{ with .Params.description }}<p class="ps5-tile-description">{{ . }}</p>{{ end }}

                    <!-- Technologies principales -->
                    {{ if .Params.technologies }}
                    <div class="ps5-tile-tech">
                        {{ $techCount := len .Params.technologies }}
                        {{ range first 3 .Params.technologies }}
                            {{ $techName := . }}
                            {{ $found := false }}
                            {{ range $.Site.Data.technologies }}
                                {{ if eq .name $techName }}<span class="ps5-tile-tech-item">{{ partial "tech-icon.html" . }} {{ .name }}</span>{{ $found = true }}{{ end }}
                            {{ end }}
                            {{ if not $found }}<span class="ps5-tile-tech-item">{{ $techName }}</span>{{ end }}
                        {{ end }}
                        {{ if gt $techCount 3 }}<span class="ps5-tile-tech-more">+{{ sub $techCount 3 }}</span>{{ end }}
                    </div>
                    {{ end }}

                    <div class="ps5-tile-meta">
                        <span class="ps5-tile-date">{{ .Date.Format "2006" }}</span>
                        <a href="{{ .Permalink }}" class="ps5-tile-btn">
                            {{ i18n "see_project" | default "Voir le projet" }}
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Lien principal invisible -->
            <a href="{{ .Permalink }}" class="ps5-tile-link" aria-label="{{ i18n "see_project" | default "Voir le projet" }}: {{ .Title }}"></a>
        </article>
        {{ end }}
        {{ end }}
    </div><!-- /.ps5-projects-tiles -->
    </div><!-- /.projects-scroll-area -->

</div>

{{/* Inclusion du JS PS5 Projects */}}
{{ with resources.Get "js/ps5-projects.js" }}
<script src="{{ .RelPermalink }}"></script>
{{ end }}
<script>
// Ajuste dynamiquement la hauteur de la zone scroll pour √©viter coupures si header/filtres changent
(() => {
    const area = document.querySelector('.projects-scroll-area');
    if(!area) return;
    const recalc = () => {
        const header = document.querySelector('.projects-page-header');
        const filters = document.querySelector('.projects-filters-bar');
        const viewportH = window.innerHeight;
        const headerH = header ? header.getBoundingClientRect().height : 0;
        const filtersH = filters ? filters.getBoundingClientRect().height : 0;
        const topOffset = area.getBoundingClientRect().top;
        const available = viewportH - topOffset - 24; // marge bas
        if(window.matchMedia('(max-width:560px)').matches){
            area.style.height = 'auto';
            area.style.maxHeight = 'none';
        } else {
            area.style.height = available + 'px';
        }
    };
    window.addEventListener('resize', recalc, { passive:true });
    window.addEventListener('orientationchange', recalc);
    setTimeout(recalc, 50);
})();
</script>
{{ end }}
