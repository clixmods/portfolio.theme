{{ define "main" }}
  {{/* CV Page - utilise les donn√©es de /data */}}
  {{ $profile := site.Data.profile }}
  {{ $experiences := (.Site.GetPage "/experiences").Pages.ByParam "start_date" }}
  {{ $educations := (where (.Site.GetPage "/educations").Pages "File.BaseFileName" "!=" "_index") }}
  {{ $specialties := site.Data.specialties }}
  {{ $softSkills := site.Data.soft_skills }}
  {{ $programmingLanguages := site.Data.programming_languages }}
  {{ $frameworksEngines := site.Data.frameworks_engines }}
  {{ $technologies := site.Data.technologies }}
  {{ $certs := site.Data.certifications }}

  <style media="print">
    /* Forcer la disparition de la chrome du site lors de l'impression */
    #dock, #hero-background, footer, .contact-modal, .toast-container, .trophies-modal, .right-dock, .top-dock { display: none !important; }
    body { background: #fff !important; }
    main { margin: 0 !important; padding: 0 !important; }
    .cv-page { box-shadow: none !important; margin: 0 !important; padding: 0 !important; max-width: 100% !important; }
    .cv-export { display: none !important; }
    /* Page setup for PDF export */
    @page { size: A4; margin: 12mm; }
  </style>

  {{ $cvStyle := or .Params.cvStyle "twocol" }}
  {{ $cvAccent := or .Params.cvAccent "#111111" }}
  <section class="cv-page cv--{{ $cvStyle }}" id="cv" style="--cv-accent: {{ $cvAccent }};">
    <header class="cv-header">
      <div class="cv-identite">
        <div class="cv-id-row">
          {{ with $profile.media.profileImage }}
            <img class="cv-avatar cv-avatar--header" src="{{ . }}" alt="{{ $profile.personal.fullName }}">
          {{ end }}
          <div>
            <h1>{{ or $profile.personal.fullName (printf "%s %s" $profile.personal.firstName $profile.personal.lastName) }}</h1>
            {{ with $profile.contact.status }}<p class="cv-title">{{ . }}</p>{{ end }}
            {{ with $profile.personal.subtitle }}<p class="cv-subtag">{{ . }}</p>{{ end }}
          </div>
        </div>
      </div>
      <div class="cv-coordonnees">
        <ul class="cv-contact-list">
          {{ with $profile.contact.email }}<li>{{ . }}</li>{{ end }}
          {{ with $profile.contact.linkedin }}<li><a href="https://{{ . }}" target="_blank" rel="noopener">{{ . }}</a></li>{{ end }}
          {{ with $profile.contact.location }}<li>{{ . }}</li>{{ end }}
          {{ with $profile.contact.phone }}<li>{{ . }}</li>{{ end }}
        </ul>
        <button class="cv-export" onclick="window.print()">üñ®Ô∏è Exporter en PDF</button>
      </div>
    </header>

    <div class="cv-grid">
      <div class="cv-col cv-col-left">
        <section class="cv-section cv-summary">
          <div class="cv-summary-top">
            <div class="cv-summary-text">
              {{ with $profile.personal.title }}<p class="cv-item-desc">{{ . }}</p>{{ end }}
            </div>
          </div>
          {{ with $specialties }}
            {{ range . }}
              {{ with .category }}
                <ul class="cv-summary-bullets">
                  <li>D√©veloppeur logiciel et de jeu vid√©o passionn√©</li>
                  <li>Expertise dans :
                    <ul>
                      {{ range first 4 .skills }}<li>{{ .name }}</li>{{ end }}
                    </ul>
                  </li>
                </ul>
              {{ end }}
            {{ end }}
          {{ end }}
        </section>

    {{ with $programmingLanguages }}
        {{ range . }}
          {{ with .category }}
          <section class="cv-section">
            <h2>Langage Prog.</h2>
            <ul class="cv-list">
              {{ range first 6 .skills }}
                {{ $techName := .technologyRef }}
                {{ $techResults := where $technologies "name" $techName }}
                {{ if $techResults }}
                  {{ $tech := index $techResults 0 }}
                <li class="cv-item">
                  <div class="cv-item-header">
                    <strong>{{ $tech.name }}</strong>
                    <span class="cv-item-period">
                      {{ if .customSubtitle }}
                        {{ .customSubtitle }}
                      {{ else }}
                        {{ $tech.level }}
                      {{ end }}
                    </span>
                  </div>
                </li>
                {{ end }}
              {{ end }}
            </ul>
          </section>
          {{ end }}
        {{ end }}
    {{ end }}

    {{ if $educations }}
          <section class="cv-section">
            <h2>Formations</h2>
            <ul class="cv-list">
      {{ range first 2 (sort $educations "Params.start_date" "desc") }}
                <li class="cv-item">
                  <div class="cv-item-header">
                    <strong>{{ .Title }}</strong> ‚Äî <span>{{ .Params.institution }}{{ if .Params.city }}, {{ .Params.city }}{{ end }}</span>
                    <span class="cv-item-period">
                      {{ if .Params.start_date }}
                        {{ dateFormat "2006" .Params.start_date }} - 
                        {{ if .Params.end_date }}
                          {{ dateFormat "2006" .Params.end_date }}
                        {{ else }}
                          Pr√©sent
                        {{ end }}
                      {{ end }}
                    </span>
                  </div>
                </li>
              {{ end }}
            </ul>
          </section>
        {{ end }}
      </div>
      <div class="cv-col cv-col-right">
        {{ if or $specialties $softSkills }}
          <section class="cv-section">
            <h2>Comp√©tences</h2>
            <div class="cv-skill-split">
              <div class="cv-skill-col">
                <h3>Techniques</h3>
                <ul class="cv-tags cv-skill-chips">
                  {{ with $specialties }}
                    {{ range . }}
                      {{ with .category }}
                        {{ range first 5 .skills }}<li>{{ .name }}</li>{{ end }}
                      {{ end }}
                    {{ end }}
                  {{ end }}
                </ul>
              </div>
              <div class="cv-skill-col">
                <h3>Travail</h3>
                <ul class="cv-tags cv-skill-chips">
                  {{ with $softSkills }}
                    {{ range . }}
                      {{ with .category }}
                        {{ range first 5 .skills }}<li>{{ .name }}</li>{{ end }}
                      {{ end }}
                    {{ end }}
                  {{ end }}
                </ul>
              </div>
            </div>
          </section>
        {{ end }}

        {{ if $experiences }}
          <section class="cv-section">
            <h2>Exp√©riences Pro.</h2>
            <ul class="cv-list">
              {{ range $i, $exp := first 1 $experiences }}
                {{ $experienceData := partial "helpers/experience-data.html" $exp }}
                <li class="cv-item">
                  <div class="cv-item-header">
                    <strong>{{ $exp.Title }}</strong> ‚Äî <span>{{ $exp.Params.company }}</span>
                    <span class="cv-item-period">{{ $experienceData.period }}{{ with $experienceData.duration }} ¬∑ {{ . }}{{ end }}</span>
                  </div>
                  {{ with $exp.Params.description }}<p class="cv-item-desc">{{ . | truncate 160 }}</p>{{ end }}
                  {{ if and (eq $i 0) $exp.Params.projects (gt (len $exp.Params.projects) 0) }}
                    {{ $pref := index $exp.Params.projects 0 }}
                    {{ $proj := "" }}
                    {{ if hasPrefix $pref.project_ref "/" }}
                      {{ $proj = $.Site.GetPage $pref.project_ref }}
                    {{ else }}
                      {{ $proj = $.Site.GetPage (printf "/projects/%s" $pref.project_ref) }}
                    {{ end }}
                    {{ with $proj }}
                      {{ $img := .Params.image }}
                      {{ if $img }}
                        <img class="cv-thumb" src="{{ $img }}" alt="{{ .Title }}">
                      {{ end }}
                    {{ end }}
                  {{ end }}
                </li>
              {{ end }}
            </ul>
          </section>
        {{ end }}

  {{ $allProjects := where .Site.RegularPages "Section" "projects" }}
  {{ $apps := where $allProjects ".Params.sector" "apps-web" }}
        {{ if $apps }}
          <section class="cv-section">
            <h2>Projets Informatique</h2>
            <ul class="cv-list">
              {{ range first 2 $apps }}
                <li class="cv-item">
                  <div class="cv-item-header">
                    <strong>{{ .Title }}</strong>
                    {{ with .Params.period }}<span class="cv-item-period">{{ . }}</span>{{ end }}
                  </div>
                  {{ with .Params.description }}<p class="cv-item-desc">{{ . | plainify | truncate 120 }}</p>{{ end }}
                </li>
              {{ end }}
            </ul>
          </section>
        {{ end }}

        {{ if $certs }}
          <section class="cv-section">
            <h2>Certifications</h2>
            <ul class="cv-list">
              {{ range first 2 $certs }}
                <li class="cv-item">
                  <div class="cv-item-header">
                    <strong>{{ .title }}</strong> ‚Äî <span>{{ .issuer }}</span>
                    <span class="cv-item-period">{{ .date }}</span>
                  </div>
                </li>
              {{ end }}
            </ul>
          </section>
        {{ end }}
      </div>
    </div>
  </section>
  <script>
    (function(){
      try {
        const params = new URLSearchParams(window.location.search);
        if (params.get('download') === '1') {
          // Wait a tick to ensure layout is complete before printing
          window.addEventListener('load', function(){
            setTimeout(function(){ window.print(); }, 150);
          });
        }
      } catch (e) { /* ignore */ }
    })();
  </script>
{{ end }}
