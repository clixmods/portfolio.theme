{{- define "main" -}}
<!-- CSS pour les formations style PS5 -->
{{ with resources.Get "css/ps5-educations.css" }}
<link rel="stylesheet" href="{{ .RelPermalink }}">
{{ end }}

<div class="ps5-educations-page">
    <!-- Fond dynamique -->
    <div id="education-bg" aria-hidden="true"></div>
    
    <!-- En-t√™te de la page -->
    <section class="educations-page-header" aria-labelledby="educations-main-title">
        <div class="educations-heading-block">
            <h1 id="educations-main-title" class="educations-list-title">{{ .Title }}</h1>
            <p class="educations-list-subtitle">
                {{ .Params.description | default .Content | default "D√©couvrez mon parcours acad√©mique et les formations qui m'ont permis de d√©velopper mes comp√©tences en d√©veloppement de jeux vid√©o et en informatique." }}
            </p>
        </div>
        
        <!-- Stats rapides -->
        <div class="educations-quick-stats">
            {{ $all := where .Site.RegularPages "Section" "educations" }}
            {{ $completed := where $all ".Params.status" "Obtenu" }}
            {{ $inProgress := where $all ".Params.status" "En cours" }}
            {{ $gamesDev := where $all ".Params.specialties" "intersect" (slice "D√©veloppement de jeux vid√©o") }}
            <div class="eqs-item">
                <span class="eqs-number">{{ len $all }}</span>
                <span class="eqs-label">Total</span>
            </div>
            <div class="eqs-item">
                <span class="eqs-number">{{ len $completed }}</span>
                <span class="eqs-label">Termin√©es</span>
            </div>
            <div class="eqs-item">
                <span class="eqs-number">{{ len $inProgress }}</span>
                <span class="eqs-label">En cours</span>
            </div>
            <div class="eqs-item">
                <span class="eqs-number">{{ len $gamesDev }}</span>
                <span class="eqs-label">Game Dev</span>
            </div>
        </div>
    </section>

    <!-- Grille des formations -->
    <div class="educations-scroll-area">
        <div class="ps5-educations-tiles">
            {{- range .Pages -}}
            {{- if not (eq .File.LogicalName "_index.md") -}}
            <article class="ps5-education-tile"
                 data-education-id="{{ .File.BaseFileName }}"
                 data-status="{{ .Params.status }}"
                 data-institution="{{ .Params.institution }}">
                
                <!-- Image/Logo de l'institution -->
                <div class="ps5-tile-image">
                    {{- if .Params.school_logo -}}
                        <img loading="lazy" src="{{ .Params.school_logo | relURL }}" alt="Logo {{ .Params.institution }}">
                    {{- else -}}
                        <div class="ps5-tile-placeholder">
                            <span class="placeholder-icon">{{ .Params.icon | default "üéì" }}</span>
                        </div>
                    {{- end -}}
                    <div class="ps5-tile-overlay"></div>
                </div>

                <!-- Badge de statut -->
                {{- $status := .Params.status | default "En cours" -}}
                <div class="ps5-tile-badge ps5-status-{{ if eq $status "Obtenu" }}completed{{ else if eq $status "En cours" }}current{{ else }}unknown{{ end }}">
                    {{- if eq $status "Obtenu" -}}
                        ‚úÖ
                    {{- else if eq $status "En cours" -}}
                        üü¢
                    {{- else -}}
                        {{ .Params.icon | default "üéì" }}
                    {{- end -}}
                </div>

                <!-- Contenu principal -->
                <div class="ps5-tile-content">
                    <h3 class="ps5-tile-title">{{ .Title }}</h3>
                    <p class="ps5-tile-institution">{{ .Params.institution }}</p>
                    {{- if .Params.city -}}
                        <p class="ps5-tile-city">üìç {{ .Params.city }}</p>
                    {{- end -}}
                </div>

                <!-- Overlay avec d√©tails -->
                <div class="ps5-tile-info">
                    <div class="ps5-tile-info-content">
                        <h3 class="ps5-tile-info-title">{{ .Title }}</h3>
                        <p class="ps5-tile-info-institution">{{ .Params.institution }}{{ if .Params.city }} - {{ .Params.city }}{{ end }}</p>
                        <p class="ps5-tile-description">{{ .Params.description }}</p>

                        <!-- P√©riode et r√©sultats -->
                        <div class="ps5-tile-period">
                            {{- if .Params.start_date -}}
                                {{- $startYear := (time .Params.start_date).Format "2006" -}}
                                {{- $endYear := "" -}}
                                {{- if .Params.end_date -}}
                                    {{- $endYear = (time .Params.end_date).Format "2006" -}}
                                {{- else -}}
                                    {{- $endYear = "En cours" -}}
                                {{- end -}}
                                <span class="period-dates">üìÖ {{ $startYear }} - {{ $endYear }}</span>
                            {{- end -}}
                            {{- if .Params.grade -}}
                                <span class="period-grade">üèÜ {{ .Params.grade }}</span>
                            {{- end -}}
                        </div>

                        <!-- Technologies principales -->
                        {{- if or .Params.programming_languages .Params.frameworks_engines .Params.specialties -}}
                        <div class="ps5-tile-tech">
                            {{- if .Params.programming_languages -}}
                                {{- range first 2 .Params.programming_languages -}}
                                    {{- $techName := . -}}
                                    {{- $found := false -}}
                                    {{- range $.Site.Data.programming_languages -}}
                                        {{- if eq .name $techName -}}
                                            <span class="ps5-tile-tech-item">{{ partial "tech-icon.html" . }} {{ .name }}</span>
                                            {{- $found = true -}}
                                        {{- end -}}
                                    {{- end -}}
                                    {{- if not $found -}}
                                        <span class="ps5-tile-tech-item">{{ $techName }}</span>
                                    {{- end -}}
                                {{- end -}}
                            {{- end -}}
                            {{- if .Params.frameworks_engines -}}
                                {{- range first 2 .Params.frameworks_engines -}}
                                    {{- $techName := . -}}
                                    {{- $found := false -}}
                                    {{- range $.Site.Data.frameworks_engines -}}
                                        {{- if eq .name $techName -}}
                                            <span class="ps5-tile-tech-item">{{ partial "tech-icon.html" . }} {{ .name }}</span>
                                            {{- $found = true -}}
                                        {{- end -}}
                                    {{- end -}}
                                    {{- if not $found -}}
                                        <span class="ps5-tile-tech-item">{{ $techName }}</span>
                                    {{- end -}}
                                {{- end -}}
                            {{- end -}}
                            {{- if .Params.specialties -}}
                                {{- range first 1 .Params.specialties -}}
                                    <span class="ps5-tile-tech-item specialty">{{ . }}</span>
                                {{- end -}}
                            {{- end -}}
                            {{- $totalCount := 0 -}}
                            {{- if .Params.programming_languages -}}{{- $totalCount = add $totalCount (len .Params.programming_languages) -}}{{- end -}}
                            {{- if .Params.frameworks_engines -}}{{- $totalCount = add $totalCount (len .Params.frameworks_engines) -}}{{- end -}}
                            {{- if .Params.specialties -}}{{- $totalCount = add $totalCount (len .Params.specialties) -}}{{- end -}}
                            {{- if gt $totalCount 5 -}}
                                <span class="ps5-tile-tech-more">+{{ sub $totalCount 5 }}</span>
                            {{- end -}}
                        </div>
                        {{- end -}}

                        <div class="ps5-tile-meta">
                            <span class="ps5-tile-status">{{ $status }}</span>
                            <a href="{{ .RelPermalink }}" class="ps5-tile-btn">
                                Voir les d√©tails
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M5 12h14M12 5l7 7-7 7"/>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Lien principal invisible -->
                <a href="{{ .RelPermalink }}" class="ps5-tile-link" aria-label="Voir la formation: {{ .Title }}"></a>
            </article>
            {{- end -}}
            {{- end -}}
        </div>
    </div>
</div>

<!-- JavaScript pour les interactions -->
{{ with resources.Get "js/ps5-educations.js" }}
<script src="{{ .RelPermalink }}"></script>
{{ end }}
<script>
// Ajuste dynamiquement la hauteur de la zone scroll
(() => {
    const area = document.querySelector('.educations-scroll-area');
    if(!area) return;
    const recalc = () => {
        const header = document.querySelector('.educations-page-header');
        const viewportH = window.innerHeight;
        const headerH = header ? header.getBoundingClientRect().height : 0;
        const topOffset = area.getBoundingClientRect().top;
        const available = viewportH - topOffset - 24; // marge bas
        if(window.matchMedia('(max-width:768px)').matches){
            area.style.height = 'auto';
            area.style.maxHeight = 'none';
        } else {
            area.style.height = available + 'px';
        }
    };
    window.addEventListener('resize', recalc, { passive:true });
    window.addEventListener('orientationchange', recalc);
    setTimeout(recalc, 50);
})();
</script>

{{- end -}}
